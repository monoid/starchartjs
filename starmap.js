function StarMap (elt, size, prop) {
    this.paper = new Raphael(elt, size, size);
    this.size = size;
    var halfsize = Math.floor(size/2);

    this.circle = this.paper.circle(halfsize, halfsize, halfsize);
    this.circle.attr({fill: (prop.circleFill || "#000010")});
    this.constel = this.paper.set();
    this.eqGrid = prop.eqGrid ? this.paper.set() : null;
    this.stars = this.paper.set();
}

StarMap.DEG2RAD = Math.PI/180.0;

StarMap.STARS=[[3,298.8282,6.407933],[0,297.69452,8.867385],[2,296.56488,10.613269],[3,291.37396,3.1145792],[3,298.1182,1.0056783],[3,302.8261,-0.8214757],[2,286.35254,13.863709],[4,284.9058,15.068478],[3,286.5623,-4.8823347],[2,2.0965333,29.090828],[3,9.8316555,30.861225],[2,17.43249,35.62083],[2,30.974663,42.32985],[3,14.187907,38.499256],[4,12.453457,41.078957],[4,353.24246,-37.81836],[4,14.651442,-29.357464],[4,349.70593,-32.531837],[3,271.65784,-50.091454],[2,262.9605,-49.87598],[3,254.65512,-55.990055],[3,252.4463,-59.041317],[3,262.7749,-60.683605],[3,261.34857,-56.37769],[2,261.32498,-55.529823],[4,238.45616,-16.729622],[3,233.88141,-14.789554],[2,229.25197,-9.382867],[2,222.71991,-16.04161],[3,226.01776,-25.281857],[4,33.250046,8.846752],[4,37.039658,8.460089],[3,26.021364,-15.939556],[2,10.896785,-17.986685],[3,4.8570127,-8.82383],[3,17.146933,-10.181928],[3,21.006046,-8.182754],[3,27.865044,-10.334946],[4,36.487553,-12.290452],[4,39.89055,-11.871582],[4,41.030643,-13.858676],[4,38.021988,-15.24432],[6,34.836613,-2.9770606],[4,39.870617,0.3285168],[3,40.82552,3.2361717],[2,45.569912,4.0899253],[4,44.928734,8.907401],[4,41.23489,10.11422],[4,38.968704,5.593302],[3,42.49579,27.26079],[2,31.792858,23.462778],[2,28.659788,20.8083],[3,28.382355,19.294092],[4,281.79367,-4.7478285],[5,281.87073,-5.705071],[5,283.67966,-15.603023],[4,277.29938,-14.565805],[3,278.80182,-8.243308],[3,130.02557,-35.3083],[3,130.89812,-33.186413],[4,132.63338,-27.710058],[3,220.28717,13.728332],[-1,213.91812,19.18727],[2,221.24687,27.074173],[3,228.87543,33.3151],[3,225.48663,40.390636],[3,218.01982,38.307884],[3,217.95775,30.371145],[2,208.67131,18.398588],[4,207.36957,15.797806],[5,67.70874,-44.953743],[4,70.14093,-41.86357],[5,70.51436,-37.144768],[4,124.63028,-76.91998],[4,158.86758,-78.60781],[4,184.58727,-79.31227],[4,131.67432,28.760006],[4,130.82172,21.468596],[5,125.016136,27.218622],[3,131.1713,18.154863],[3,124.12895,9.185663],[4,134.62166,11.857772],[3,304.5134,-12.544859],[3,305.2527,-14.781402],[4,316.48657,-17.232712],[4,320.56158,-16.834555],[3,325.02225,-16.662254],[2,326.75952,-16.126566],[3,321.66678,-22.411379],[4,311.52402,-25.270517],[4,312.9554,-26.919127],[1,138.30101,-69.717476],[3,153.4345,-70.03792],[2,160.73927,-64.39448],[4,160.88461,-60.566628],[3,167.14748,-58.97504],[3,163.3732,-58.853264],[3,156.96977,-58.73941],[3,154.27086,-61.33232],[2,139.27261,-59.27526],[4,130.15431,-59.761013],[1,125.6286,-59.509537],[-1,95.98788,-52.695717],[3,137.74211,-58.96693],[3,99.4403,-43.195923],[2,120.896126,-40.00319],[3,28.59868,63.670147],[2,21.452513,60.235405],[2,14.177088,60.71675],[2,10.126614,56.53741],[2,2.2920403,59.15022],[-1,219.92041,-60.835148],[0,210.95602,-60.37298],[2,204.97197,-53.466362],[2,208.88515,-47.288265],[3,209.66988,-44.80353],[3,207.4042,-42.473686],[3,207.37624,-41.68766],[3,202.76112,-39.40728],[2,200.15027,-36.712082],[2,211.67218,-36.368694],[2,218.87688,-42.157745],[3,224.7904,-42.10414],[2,190.38002,-48.959885],[3,187.01006,-50.230606],[2,182.08977,-50.72241],[4,173.69046,-54.264133],[3,173.94554,-63.019825],[3,332.7136,58.20125],[3,342.42047,66.200714],[3,322.1649,70.56069],[2,319.6441,62.585457],[3,354.83743,77.631966],[4,197.49812,17.529116],[4,197.9705,27.876038],[4,186.7347,28.26862],[4,188.43788,41.35677],[2,194.00768,38.318245],[2,89.93016,37.212765],[1,89.88237,44.947433],[0,79.172066,45.99903],[3,75.6195,41.07589],[2,74.2484,33.166134],[1,81.57291,28.607874],[3,95.52852,-33.43627],[4,94.13806,-35.14073],[4,89.38422,-35.283306],[3,87.73981,-35.76929],[3,89.78663,-42.81511],[2,84.91225,-34.07405],[3,82.80306,-35.470436],[3,220.62785,-64.97457],[4,230.8444,-59.320698],[4,229.379,-58.80088],[4,164.9448,-18.299097],[4,167.91452,-22.825607],[4,171.22076,-17.684017],[3,169.83551,-14.779043],[4,171.15253,-10.859383],[4,174.17062,-9.802254],[5,179.0041,-17.150808],[4,176.19066,-18.350615],[5,280.9456,-38.32331],[5,284.1687,-37.34318],[4,284.68115,-37.10709],[4,286.60434,-37.062756],[4,287.36783,-37.90424],[4,287.5073,-39.340706],[4,287.08722,-40.49664],[4,285.77847,-42.094994],[5,284.0707,-42.7106],[5,278.08878,-39.70391],[4,233.23248,31.359156],[3,231.95772,29.105492],[2,233.67162,26.71491],[3,235.68599,26.295515],[4,237.39874,26.06855],[4,239.3971,26.878027],[4,240.3608,29.851078],[4,188.01869,-16.195866],[2,187.4666,-16.515095],[2,183.95195,-17.541985],[3,182.53136,-22.619793],[4,182.10313,-24.72878],[2,188.5968,-23.396624],[1,187.79137,-57.112568],[0,186.64975,-63.099056],[1,191.9305,-59.688732],[2,183.78648,-58.7489],[3,289.27545,53.36816],[3,292.42642,51.72947],[2,296.2435,45.13069],[2,305.5571,40.256683],[1,310.35797,45.280334],[2,311.5518,33.96945],[3,318.2341,30.227081],[4,326.035,28.743223],[3,299.07666,35.083492],[3,292.68036,27.959694],[4,308.3032,11.303332],[3,309.38696,14.595202],[3,309.9094,15.912053],[4,311.66467,16.124773],[4,310.86478,15.074682],[4,86.19341,-65.73554],[4,88.52458,-63.091022],[3,83.40632,-62.489857],[3,68.498825,-55.045006],[4,64.00622,-51.487095],[3,268.38177,56.87245],[2,269.15158,51.488953],[2,262.60825,52.301357],[4,263.06616,55.172806],[3,288.13815,67.661316],[3,297.04254,70.26784],[3,275.25974,72.733696],[3,257.19678,65.71464],[2,245.99794,61.514076],[4,240.47377,58.564438],[3,231.23244,58.966022],[3,211.09761,64.37581],[3,188.37102,69.78821],[3,172.8512,69.33112],[4,243.36972,-54.630413],[4,244.9607,-50.15538],[4,246.79604,-47.554737],[4,240.80359,-49.22972],[0,24.428131,-57.23666],[3,28.986801,-51.60959],[3,34.127083,-51.51211],[4,36.74627,-47.703827],[4,39.949665,-42.891632],[4,40.16638,-39.85531],[2,44.565483,-40.304733],[4,49.97177,-43.07155],[4,57.14926,-37.62013],[4,57.36367,-36.20011],[3,64.47341,-33.798332],[3,66.009026,-34.016987],[3,68.8878,-30.562311],[4,56.712456,-23.248438],[4,53.446865,-21.632816],[3,49.87904,-21.757942],[4,45.598305,-23.624336],[4,41.27492,-18.57265],[3,44.10668,-8.89761],[4,48.958447,-8.81984],[3,53.23509,-9.458306],[3,55.812317,-9.765199],[3,69.07975,-3.352448],[4,71.37559,-3.2546246],[4,73.22367,-5.452756],[2,76.96264,-5.0862627],[4,77.2866,-8.754076],[3,69.545296,-14.303587],[4,295.26224,17.476124],[3,296.84692,18.53426],[4,295.0241,18.013939],[3,299.68912,19.492092],[5,301.2895,19.990877],[4,42.27233,-32.406284],[3,48.017834,-28.989107],[1,99.427925,16.399414],[4,106.02723,20.5703],[3,110.03079,21.98234],[3,109.52336,16.540476],[3,101.32264,12.896055],[4,113.98072,26.896004],[3,116.11195,24.398129],[1,116.33068,28.02631],[3,111.431984,27.798286],[4,107.784966,30.245281],[1,113.65002,31.888636],[3,103.19725,33.96137],[3,100.98304,25.131155],[4,97.24079,20.212168],[2,95.73996,22.513851],[3,93.71957,22.506824],[4,91.03007,23.263632],[4,52.267227,59.940334],[4,59.35598,63.07225],[4,73.51254,66.34266],[4,57.58948,71.33237],[5,80.64074,79.23076],[4,103.54784,-12.038592],[4,105.93955,-15.633259],[4,104.03428,-17.054247],[-2,101.28854,-16.713142],[3,105.75614,-23.833302],[1,107.09786,-26.393208],[4,108.70276,-26.772686],[2,111.02377,-29.30312],[1,104.65644,-28.97209],[3,105.4298,-27.934841],[6,103.55436,-23.928349],[3,99.17083,-19.255709],[4,98.764084,-22.964832],[1,95.67495,-17.955917],[3,102.46027,-32.508488],[3,95.07828,-30.063377],[1,206.8856,49.3133],[2,200.98091,54.925415],[1,193.5068,55.959843],[3,183.85603,57.032597],[1,165.93265,61.751118],[2,165.45996,56.382343],[2,178.45726,53.694733],[3,176.51306,47.77934],[3,167.41608,44.498554],[3,154.27469,42.914467],[3,155.58252,41.49943],[4,148.0265,54.064285],[3,143.21802,51.6786],[3,135.9065,47.15666],[3,134.8035,48.04235],[3,147.74872,59.039104],[3,127.566795,60.71843],[3,142.88155,63.061794],[4,346.71988,-43.520325],[3,337.31732,-43.495556],[1,332.05783,-46.960617],[2,340.66638,-46.884567],[3,347.5893,-45.246647],[4,345.2203,-52.754105],[3,342.13834,-51.316704],[4,331.52878,-39.54305],[3,328.4819,-37.364822],[3,264.8662,46.00632],[3,269.06323,37.250523],[4,260.92072,37.145924],[4,259.41785,37.291344],[3,258.7619,36.809155],[3,250.7239,38.922462],[4,248.52579,42.436897],[3,244.9352,46.31327],[4,238.16748,42.44999],[2,250.32281,31.601887],[2,247.55525,21.489649],[3,245.48018,19.153023],[3,255.07253,30.92634],[4,262.68457,26.110605],[3,258.75803,24.839588],[3,266.6155,27.7225],[3,269.44095,29.247925],[3,271.88562,28.76247],[3,63.50034,-42.293873],[5,40.164917,-54.549923],[5,45.903767,-59.73762],[4,130.8062,3.3986654],[4,129.68938,3.3414748],[4,129.4142,5.703799],[3,131.69437,6.4189067],[4,132.10826,5.837885],[3,133.8487,5.9455276],[3,138.5908,2.3150241],[4,142.99556,-1.1846544],[4,142.28683,-2.7689562],[1,141.89688,-8.658684],[4,147.8695,-14.84655],[3,152.64749,-12.353839],[3,156.52293,-16.836096],[3,162.40596,-16.194132],[3,173.25108,-31.857525],[4,178.22734,-33.90813],[4,197.26367,-23.117973],[2,199.73022,-23.171412],[2,6.413342,-77.255035],[3,56.8093,-74.23924],[4,39.896767,-68.266945],[4,35.437595,-68.659424],[2,29.691133,-61.569923],[4,319.9662,-53.449265],[3,309.39163,-47.291664],[3,313.70242,-58.454094],[4,333.99237,37.748734],[4,337.62192,43.12339],[4,337.3826,47.706894],[4,336.12915,49.476402],[4,335.89014,52.2295],[3,337.8224,50.28245],[3,93.713905,-6.2747273],[3,97.204475,-7.0330505],[4,107.96609,-0.49278057],[4,95.94207,4.592839],[5,92.24127,2.4997268],[4,122.148575,-2.9837766],[3,115.31199,-9.551084],[4,91.538895,-14.9352865],[3,89.101326,-14.168038],[3,86.73896,-14.821947],[2,83.182556,-17.822292],[3,78.2328,-16.20543],[3,87.8298,-20.877514],[3,86.11656,-22.447487],[2,82.06136,-20.759232],[3,76.36522,-22.370857],[4,79.89386,-13.176777],[4,78.30785,-12.941288],[4,78.07453,-11.869143],[5,79.995964,-12.315604],[2,177.26616,14.572337],[3,168.56017,15.429763],[1,152.09358,11.9671955],[3,151.83315,16.762665],[2,154.99234,19.84186],[2,168.52672,20.524035],[3,154.17252,23.417328],[3,148.1915,26.007086],[2,146.46292,23.774279],[3,237.73976,-33.627106],[5,241.8174,-36.75554],[3,240.03058,-38.39664],[2,233.78525,-41.166695],[3,230.34306,-40.64746],[3,230.45181,-36.261166],[2,224.63315,-43.133865],[4,234.51384,-42.567486],[3,228.07169,-52.099075],[2,220.48239,-47.38814],[4,219.47188,-49.42576],[4,216.54501,-45.37926],[3,140.2644,34.392525],[3,139.71112,36.8029],[4,136.63245,38.45225],[3,135.16147,41.783443],[4,125.70888,43.188374],[4,111.67859,49.211643],[4,104.31916,58.42306],[4,94.90579,59.010906],[0,279.2341,38.782993],[4,281.19305,37.60505],[3,282.52,33.36268],[3,284.73593,32.689552],[4,283.6262,36.898605],[4,156.78815,-31.067802],[5,149.71808,-35.890934],[4,319.48438,-32.172485],[4,315.32275,-32.257767],[4,312.492,-33.779675],[3,191.5703,-68.10809],[3,176.40236,-66.72884],[3,188.11713,-72.13297],[2,189.29619,-69.13554],[3,325.36865,-77.389465],[4,341.5155,-81.381615],[4,216.73225,-83.667854],[3,221.96553,-79.044716],[3,248.36444,-78.89696],[4,250.77258,-77.51657],[2,263.73337,12.5605755],[2,265.86823,4.566917],[2,257.59442,-15.725147],[3,254.4178,9.375056],[3,244.58017,-4.692608],[2,249.2897,-10.567152],[4,262.85397,-23.96258],[1,85.18969,-1.9425784],[1,84.05338,-1.2019173],[2,83.00166,-0.2990934],[5,90.864,19.69061],[4,92.984985,14.208815],[4,91.893005,14.768523],[4,88.59618,20.276415],[4,90.595795,9.6473675],[0,88.79287,7.4070363],[2,86.93912,-9.669601],[0,78.63446,-8.201639],[1,81.28278,6.3497343],[3,83.78449,9.934163],[3,72.45891,6.9612474],[3,72.80152,5.6051016],[5,73.34481,2.508265],[4,74.63709,1.714035],[4,72.65301,8.900252],[4,73.72377,10.151145],[1,306.41187,-56.734882],[4,321.61038,-65.36814],[3,311.2398,-66.20324],[3,302.1744,-66.17932],[3,300.14746,-72.91019],[4,280.75888,-71.42773],[4,284.23767,-67.233536],[4,283.05432,-62.18756],[4,275.80676,-61.493904],[4,272.14496,-63.66805],[3,266.43335,-64.72373],[2,3.3089583,15.183616],[2,346.19006,15.205368],[2,345.94305,28.082455],[2,340.75055,30.221308],[5,332.30698,33.172497],[3,342.50043,24.601685],[3,341.6327,23.56568],[3,331.75198,25.345047],[4,326.16125,25.645002],[4,341.67267,12.174084],[3,340.36533,10.831391],[3,332.54926,6.197789],[2,326.04642,9.875008],[3,102.04807,-61.94198],[4,87.45657,-56.16649],[3,86.82118,-51.06671],[3,56.079693,32.288273],[2,58.532993,31.883657],[3,59.74125,35.791027],[2,59.46342,40.010273],[3,55.731174,47.787655],[1,51.08062,49.861244],[2,46.199127,53.50645],[3,42.674137,55.89553],[2,47.042206,40.95565],[3,46.29374,38.840534],[4,42.645477,38.31891],[4,317.5853,10.131948],[4,318.61996,10.007718],[5,320.72327,6.8111134],[3,318.9558,5.248074],[0,114.82724,5.2275076],[2,111.7878,8.289409],[3,163.32767,34.215565],[4,156.97122,36.707478],[4,151.8572,35.24469],[4,143.55574,36.397614],[4,292.17673,24.665165],[4,300.27505,27.753565],[1,37.946148,89.26414],[4,263.05374,86.58633],[4,251.49234,82.037254],[4,236.01443,77.7945],[4,244.37709,75.75471],[3,230.18228,71.83398],[2,222.67665,74.15548],[3,17.096085,-55.24583],[3,16.521276,-46.71849],[3,6.550484,-43.67991],[3,22.812424,-49.07308],[4,28.411749,-46.302444],[3,22.091423,-43.31773],[2,6.5702806,-42.305122],[3,2.3522494,-45.74699],[5,15.704528,31.804337],[4,18.437231,24.583765],[4,19.866575,27.264088],[3,22.870808,15.345831],[4,26.348286,9.157641],[3,30.51167,2.7637606],[4,28.388903,3.1874785],[4,25.357948,5.4876046],[4,22.545595,6.1439333],[4,15.736066,7.8900723],[5,12.0722685,7.2999196],[5,5.1494346,8.1902485],[4,359.8275,6.8635936],[4,354.98676,5.6273537],[4,355.512,1.7804172],[4,351.73294,1.2558376],[3,349.28955,3.2822452],[4,351.99237,6.3790975],[1,344.41177,-29.621838],[4,340.16385,-27.043615],[5,330.20923,-28.453737],[5,326.93405,-30.898306],[4,332.53534,-32.54844],[4,337.87622,-32.346027],[4,343.98706,-32.539703],[3,115.45499,-72.60613],[3,107.18677,-70.49919],[4,121.98267,-68.617134],[3,109.20763,-67.95718],[3,126.43436,-66.13652],[4,135.61166,-66.39584],[2,121.88626,-24.304438],[5,117.25707,-24.912243],[2,109.28568,-37.09749],[2,102.4839,-50.6144],[3,112.30782,-43.30189],[3,63.605965,-62.47398],[4,64.12118,-59.30175],[4,59.686405,-61.40015],[3,56.048145,-64.80709],[2,275.2484,-29.82804],[2,276.9928,-25.421247],[3,274.4072,-36.76128],[1,276.04312,-34.384315],[2,271.45218,-30.42365],[4,266.8901,-27.830763],[2,285.653,-29.880114],[3,281.41397,-26.99078],[3,273.44086,-21.05883],[3,286.73517,-27.669815],[2,283.8163,-26.296595],[3,284.4324,-21.106625],[3,286.17056,-21.741354],[4,289.4087,-18.952883],[3,290.41824,-17.847252],[5,294.00687,-24.719017],[4,300.66443,-27.709879],[4,299.93405,-35.276245],[4,298.81534,-41.868412],[3,290.97147,-40.615646],[4,290.8044,-44.79965],[1,263.4022,-37.10375],[2,265.622,-39.029922],[2,266.89618,-40.126984],[1,264.32968,-42.99782],[3,258.03824,-43.23849],[4,253.49887,-42.36202],[3,252.96767,-38.04733],[2,252.5427,-34.29261],[2,248.97066,-28.215961],[1,247.35194,-26.431946],[2,240.08339,-22.62162],[2,239.713,-26.114042],[2,241.35931,-19.805393],[3,237.40527,-3.4301412],[3,237.70372,4.4775796],[2,236.06665,6.42552],[3,233.70079,10.538859],[3,236.54672,15.421926],[3,239.11247,15.664733],[4,237.18504,18.141779],[4,284.05484,4.2035294],[3,275.32883,-2.897122],[4,265.35382,-12.875173],[3,264.39676,-15.398408],[4,260.20682,-12.846882],[5,157.57292,-0.63697207],[4,151.98456,-0.37162787],[5,82.96942,-76.34167],[5,70.76644,-70.931114],[4,70.561264,22.956976],[3,67.15389,19.180521],[0,68.98,16.509762],[2,84.41119,21.142593],[3,64.94806,15.6277],[3,65.733444,17.542583],[3,60.170086,12.4903755],[3,51.20349,9.029065],[3,67.16531,15.870947],[4,66.372154,17.92799],[3,57.290546,24.053524],[4,277.20724,-49.07003],[3,276.74347,-45.96833],[2,334.62573,-60.259495],[3,349.35754,-58.235928],[4,5.0079756,-64.877625],[4,7.8856697,-62.958084],[5,33.984562,33.358974],[3,32.385506,34.987392],[3,28.270416,29.579397],[1,252.1661,-69.02763],[2,229.72787,-68.67947],[2,238.7867,-63.42975],[2,322.88968,-5.571156],[2,331.44595,-0.31982657],[3,335.41376,-1.3873532],[3,337.2075,-0.02006304],[4,338.83887,-0.11736123],[3,343.1536,-7.579679],[4,348.972,-9.087695],[3,350.74292,-20.100346],[4,334.2082,-7.783237],[4,331.6092,-13.86954],[4,337.66174,-10.677886],[4,342.39795,-13.592538],[3,343.66266,-15.82076],[3,347.3615,-21.172485],[3,311.91888,-9.49569],[4,176.46487,6.529814],[5,184.66791,-0.7871448],[2,190.41667,-1.4495223],[0,201.29836,-11.161245],[4,213.22392,-10.274044],[4,214.0037,-5.999526],[3,220.76485,-5.657429],[3,203.67398,-0.5959382],[4,210.41159,1.5445833],[3,221.56247,1.8929383],[3,193.90201,3.3975985],[2,195.54483,10.959102],[1,122.38315,-47.336613],[3,130.07336,-52.921974],[1,131.17583,-54.70857],[2,140.52846,-55.010696],[3,149.21565,-54.5678],[2,161.69217,-49.420124],[3,159.32607,-48.225616],[3,153.68448,-42.122063],[3,142.67548,-40.46689],[2,136.99907,-43.432625]];

StarMap.CONSTELLATIONS=[[[3,8],[6,7],[3,6],[5,4],[3,4],[1,3],[1,2],[0,1],],[[13,14],[11,13],[12,11],[10,11],[9,10],],[[17,15],[16,17],[15,16],],[[24,18],[23,24],[22,23],[21,22],[20,21],[19,20],[18,19],],[[29,26],[28,29],[27,28],[26,27],[25,26],],[[48,44],[31,48],[47,31],[46,47],[45,46],[44,45],[43,44],[42,43],[42,39],[41,32],[40,41],[39,40],[38,39],[37,38],[36,37],[35,36],[33,35],[33,34],[32,33],[30,31],],[[51,52],[50,51],[49,50],],[[57,53],[56,57],[55,56],[54,55],[53,54],],[[59,60],[58,59],],[[68,69],[62,68],[67,62],[66,67],[65,66],[64,65],[63,64],[62,63],[61,62],],[[71,72],[70,71],],[[74,75],[73,74],],[[79,81],[79,80],[77,79],[77,78],[76,77],],[[84,90],[83,89],[88,84],[85,88],[86,87],[85,86],[84,85],[83,84],[82,83],],[[101,105],[102,104],[103,100],[103,99],[101,102],[100,101],[98,99],[97,98],[96,97],[95,96],[94,95],[93,94],[92,93],[91,92],],[[109,110],[108,109],[107,108],[106,107],],[[126,127],[125,126],[124,125],[123,124],[114,123],[121,122],[116,121],[117,120],[118,119],[117,118],[116,117],[115,116],[114,115],[113,114],[112,113],[111,112],],[[132,130],[129,132],[131,128],[130,131],[129,130],[128,129],],[[134,135],[133,134],],[[136,137],],[[143,138],[143,142],[141,142],[140,141],[139,140],[138,139],],[[149,150],[147,149],[147,148],[146,147],[145,146],[144,145],],[[151,153],[151,152],],[[161,156],[160,161],[159,160],[158,159],[157,158],[157,154],[156,157],[155,156],[154,155],],[[162,171],[169,170],[168,169],[167,168],[166,167],[165,166],[164,165],[163,164],[162,163],],[[177,178],[176,177],[175,176],[174,175],[173,174],[172,173],],[[184,180],[182,184],[182,183],[181,182],[180,181],[179,180],],[[187,188],[185,186],],[[197,198],[192,197],[195,196],[194,195],[192,194],[192,193],[191,192],[190,191],[189,190],],[[203,200],[202,203],[201,202],[200,201],[199,200],],[[207,208],[206,207],[206,204],[205,206],[204,205],],[[221,222],[220,221],[219,220],[218,219],[217,218],[216,217],[215,216],[214,215],[213,214],[209,213],[212,209],[211,212],[210,211],[209,210],],[[226,223],[226,224],[225,226],[224,225],[223,224],],[[253,254],[252,253],[251,252],[250,251],[249,250],[248,249],[247,248],[246,247],[245,246],[244,245],[243,244],[242,243],[241,242],[240,241],[239,240],[238,239],[237,238],[236,237],[235,236],[234,235],[233,234],[232,233],[231,232],[230,231],[229,230],[228,229],[227,228],],[[258,259],[256,258],[256,257],[255,256],],[[260,261],],[[277,278],[276,277],[274,276],[274,275],[271,274],[271,273],[271,272],[270,271],[267,270],[267,269],[267,268],[264,267],[265,266],[264,265],[263,264],[262,263],],[[282,283],[282,281],[279,282],[280,281],[279,280],],[[286,284],[299,292],[292,298],[295,287],[295,297],[295,296],[294,295],[293,294],[293,289],[292,293],[290,291],[289,290],[288,289],[287,288],[286,287],[285,286],[284,285],],[[317,304],[316,317],[315,316],[311,315],[312,314],[312,313],[311,312],[305,311],[308,310],[308,309],[307,308],[306,307],[306,303],[305,306],[304,305],[303,304],[302,303],[301,302],[300,301],],[[325,326],[320,325],[321,324],[321,323],[322,318],[321,322],[320,321],[319,320],[318,319],],[[339,331],[343,342],[343,344],[342,343],[340,341],[339,340],[336,339],[337,338],[336,337],[332,336],[334,335],[333,334],[332,333],[331,332],[330,331],[329,330],[328,329],[327,328],],[[346,347],[345,346],],[[364,365],[363,364],[362,363],[361,362],[360,361],[359,360],[358,359],[357,358],[356,357],[355,356],[354,355],[353,354],[352,353],[352,348],[351,352],[350,351],[349,350],[348,349],],[[369,370],[368,369],[367,368],[366,367],],[[373,371],[372,373],[371,372],],[[379,376],[378,379],[377,378],[376,377],[375,376],[374,375],],[[385,386],[382,385],[383,384],[382,383],[381,382],[380,381],],[[396,399],[397,398],[395,391],[391,397],[391,396],[390,394],[394,395],[393,394],[392,393],[390,392],[390,391],[389,390],[388,389],[387,388],],[[405,401],[407,408],[406,407],[404,406],[405,400],[404,405],[403,404],[402,403],[401,402],[400,401],],[[418,415],[418,420],[417,419],[417,418],[416,417],[412,416],[413,415],[413,414],[412,413],[411,412],[411,409],[410,411],[409,410],],[[427,428],[426,427],[425,426],[424,425],[423,424],[422,423],[421,422],],[[433,430],[432,433],[431,432],[430,431],[429,430],],[[434,435],],[[437,438],[436,437],],[[442,439],[441,442],[440,441],[439,440],],[[445,443],[444,445],[443,444],],[[447,448],[446,447],],[[451,455],[454,451],[453,454],[452,453],[449,452],[451,450],[449,450],],[[461,463],[473,474],[469,473],[471,472],[470,471],[469,470],[467,469],[468,464],[467,468],[458,467],[466,458],[465,466],[456,465],[464,456],[463,464],[460,463],[461,462],[460,461],[459,460],[457,458],[456,457],],[[484,485],[484,482],[483,484],[482,483],[481,482],[481,478],[480,481],[479,480],[478,479],[478,475],[477,478],[476,477],[475,476],],[[488,487],[9,486],[9,488],[497,498],[496,497],[495,496],[487,495],[493,494],[492,493],[491,492],[488,491],[489,490],[488,489],[486,487],],[[500,501],[499,500],],[[511,512],[510,511],[507,510],[508,509],[507,508],[506,507],[505,506],[504,505],[503,504],[502,503],],[[516,513],[515,516],[514,515],[513,514],],[[517,518],],[[521,519],[521,522],[520,521],[519,520],],[[523,524],],[[531,528],[530,531],[529,530],[528,529],[527,528],[526,527],[525,526],],[[539,534],[538,539],[534,538],[537,534],[533,537],[536,533],[535,536],[533,535],[534,532],[533,534],[532,533],],[[557,553],[556,557],[555,556],[554,555],[553,554],[552,553],[551,552],[550,551],[549,550],[548,549],[547,548],[546,547],[545,546],[544,545],[543,544],[541,543],[542,541],[540,542],[540,541],],[[563,564],[562,563],[561,562],[560,561],[559,560],[558,559],],[[570,567],[569,570],[567,569],[567,568],[567,565],[566,567],[565,566],],[[105,571],[575,105],[574,575],[104,574],[573,104],[572,573],[571,572],],[[579,576],[578,579],[577,578],[576,577],],[[598,600],[598,599],[597,598],[596,597],[595,596],[589,595],[593,594],[592,593],[591,592],[590,591],[590,587],[589,590],[586,589],[581,588],[587,581],[587,580],[586,587],[583,586],[580,583],[584,580],[584,585],[583,584],[582,583],[580,581],],[[610,613],[610,612],[610,611],[609,610],[608,609],[607,608],[606,607],[605,606],[604,605],[603,604],[602,603],[601,602],],[[624,625],[623,624],[622,623],[621,622],[620,618],[619,620],[618,619],[617,618],[616,617],[615,616],[614,615],],[[626,627],],[[628,629],],[[635,640],[639,635],[631,639],[638,634],[632,638],[632,631],[636,637],[634,636],[634,635],[632,633],[630,631],[143,630],],[[641,642],],[[644,646],[644,645],[643,644],],[[649,647],[648,649],[647,648],],[[652,650],[651,652],[650,651],],[[667,653],[665,666],[664,665],[663,664],[661,663],[661,662],[654,661],[659,660],[658,659],[657,658],[656,657],[655,656],[654,655],[653,654],],[[678,670],[678,679],[675,678],[676,677],[675,676],[671,675],[673,674],[672,673],[671,672],[670,671],[669,670],[668,669],],[[689,680],[688,689],[687,688],[686,687],[685,686],[684,685],[683,684],[682,683],[681,682],[680,681]]];

function orthoProjectPoints(arr, lam1, phi1, rad) {
    var DEG2RAD = StarMap.DEG2RAD;
    lam1 *= DEG2RAD;
    phi1 *= DEG2RAD;
    var len = arr.length, i;
    var res = Array(len);
    var cphi = Math.cos(phi1), sphi = Math.sin(phi1);
    for (i = 0; i < len; ++i) {
        var star = arr[i];
        var mag = star[0], re = star[2]*DEG2RAD, de = -(star[1]*DEG2RAD-lam1);
        var cp = Math.cos(re), sp = Math.sin(re);
        var cl = Math.cos(de), sl = Math.sin(de);
        res[i] = [mag,
                  rad*cp*sl,
                  rad*(cphi*sp - sphi*cp*cl),
                  sphi*sp + cphi*cp*cl >= 0];
    }
    return res;
}

StarMap.prototype = {
    setPos: function (lat, lon) {
        var ortho = orthoProjectPoints(StarMap.STARS, lat, lon, this.size/2);
        var cst = [], i, j, slen = ortho.length, co = StarMap.CONSTELLATIONS, clen = co.length, halfsize = Math.floor(this.size/2);

        this.constel.remove();
        if (this.eqGrid) { 
            this.eqGrid.remove();
        }
        this.stars.remove();

        for (i = 0; i< clen; ++i) {
            var arc = co[i];
            for (j = arc.length; j--; ) {
                var s = arc[j][0], e = arc[j][1];
                var so = ortho[s], eo = ortho[e];
                if (so[3] && eo[3]) {
                    cst.push('M'+(so[1]+halfsize)+','+(halfsize-so[2])+' L'+(eo[1]+halfsize)+','+(halfsize-eo[2]));
                }
            }
        }

        this.constel.push(this.paper.path(cst.join(' ')).attr({
            'stroke': '#FFF',
            'stroke-width': '1'
        }));

        for (i = 0; i < slen; ++i) {
            var s = ortho[i];
            if (s[3]) {
                this.stars.push(
                    this.paper.circle(s[1]+halfsize, halfsize-s[2], Math.max(3.5-s[0]/2, 0.5)).attr({fill: '#FFF'}));
            }
        }
    }
};
